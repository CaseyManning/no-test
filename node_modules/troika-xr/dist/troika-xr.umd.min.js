'use strict';(function(f,k){"object"===typeof exports&&"undefined"!==typeof module?k(exports,require("react"),require("prop-types"),require("troika-core"),require("troika-3d"),require("troika-animation"),require("three"),require("three/examples/jsm/loaders/GLTFLoader.js"),require("troika-three-utils")):"function"===typeof define&&define.amd?define("exports react prop-types troika-core troika-3d troika-animation three three/examples/jsm/loaders/GLTFLoader.js troika-three-utils".split(" "),k):(f="undefined"!==
typeof globalThis?globalThis:f||self,k(f.troika_xr={},f.React,f.PropTypes,f.troika_core,f.troika_3d,f.troika_animation,f.THREE,f.THREE.GLTFLoader,f.troika_three_utils))})(this,function(f,k,x,g,h,ja,d,ka,B){function I(a){return a&&"object"===typeof a&&"default"in a?a:{"default":a}}function y(a,b){if(a&&b){let {position:c,orientation:e}=a.transform;b.x=c.x;b.y=c.y;b.z=c.z;b.quaternionX=e.x;b.quaternionY=e.y;b.quaternionZ=e.z;b.quaternionW=e.w}}function z(a,b){return`https://cdn.aframe.io/controllers/oculus/oculus-touch-controller-${a}-${b}.gltf`}
function w(a,b,c,e){a&&c.forEach(c=>{a[`${b?"add":"remove"}EventListener`](c,e)})}function K(a){return la(a||h.PerspectiveCamera3DFacade)}function C(a,b){a.setFramebuffer?a.setFramebuffer(b):a.state.bindXRFramebuffer?a.state.bindXRFramebuffer(b):a.state.bindFramebuffer(b)}function ma(a){a.updateMatrices&&a.updateMatrices()}function na(a){a.updateMatrices&&(a.updateMatrices(),a._checkBoundsChange())}var v=I(k);k=I(x);class oa extends v["default"].PureComponent{constructor(a){super(a);this._onClick=
this._onClick.bind(this)}_onClick(){this.props.onSelectSession(this.props.xrSession?null:"immersive-vr")}render(){let a=this.props;return v["default"].createElement("button",{onClick:this._onClick,disabled:!a.xrSupported},a.xrSupported?a.xrSession?"Exit XR":"Enter XR":"XR Not Available")}}let pa=new d.SphereGeometry,qa=new d.MeshBasicMaterial({color:16777215}),ra=new d.Vector3,sa=new d.Quaternion,ta=Math.PI/180;class L extends h.Object3DFacade{constructor(a){super(a,new d.Mesh(pa,qa.clone()));this.size=
.3;this.defaultDistance=0}afterUpdate(){let {rayIntersection:a,defaultDistance:b,targetRayPose:c}=this,e=a&&a.point;!e&&b&&c&&(e=ra.set(0,0,-1).multiplyScalar(b).applyQuaternion(sa.copy(c.transform.orientation)).add(c.transform.position));e?(e.copy.call(this,e),this.scale=e.distanceTo(this.getCameraPosition())*Math.sin(this.size*ta),this.visible=!0):this.visible=!1;super.afterUpdate()}}let M=()=>{let a=(new d.CylinderGeometry(1,1,1,4,1,!1)).translate(0,.5,0).rotateY(Math.PI/4).rotateX(Math.PI/-2);
M=()=>a;return a},N=()=>{let a=h.createDerivedMaterial(new d.MeshBasicMaterial({transparent:!0,opacity:.5,color:16777215,depthTest:!1}),{vertexDefs:"varying float dist;",vertexMainIntro:"dist = -position.z;",fragmentDefs:"varying float dist;",fragmentColorTransform:"gl_FragColor.a *= smoothstep(1.0, 0.6, dist);"});N=()=>a;return a};class O extends h.Object3DFacade{constructor(a){super(a,new d.Group);this.threeObject.add(this.laserMesh=new d.Mesh(M(),N()));this.radius=.003;this.startDistance=.05;this.maxLength=
.4;this.renderOrder=1E8}afterUpdate(){let {laserMesh:a,targetRayPose:b,radius:c,rayIntersection:e,startDistance:d,maxLength:l}=this;b?(y(b,this),a.scale.set(c,c,(e?Math.min(e.distance,l):l)-d),a.position.z=-d,a.visible=!0):a.visible=!1;super.afterUpdate()}}let P=()=>{let a=(new d.CylinderGeometry(.03,.05,.1,8)).rotateX(Math.PI/-2).translate(0,0,.05);P=()=>a;return a},Q=()=>{let a=new d.MeshStandardMaterial({color:6710886,emissive:6710886,roughness:.5,metalness:.5});Q=()=>a;return a};class R extends h.Object3DFacade{constructor(a){let b=
new d.Mesh(P(),Q());super(a,b)}}class ua extends h.Object3DFacade{constructor(a){super(a,new d.Group);this.rootTransform=this.url=null;this.autoDispose=!0}afterUpdate(){let {url:a}=this;if(a!==this._url&&(this._url=a,this.removeObjects(),a)){let b=new ka.GLTFLoader;b.setCrossOrigin("anonymous");b.load(a,a=>{this.onLoad(a)},null,a=>{console.error("Failed loading controller model",a)})}super.afterUpdate()}onLoad(a){if(this.threeObject){a=this.normalize(a);let b=a.scene;this.rootTransform&&b.applyMatrix4(this.rootTransform);
this.threeObject.add(b);b.updateMatrixWorld(!0);this.gltf=a;this.afterUpdate()}}normalize(a){return a}removeObjects(){let {gltf:a}=this;a&&a.scene&&(this.autoDispose&&a.scene.traverse(({geometry:a,material:c})=>{a&&a.dispose();c&&(c.texture&&c.texture.dispose(),c.dispose())}),this.threeObject&&this.threeObject.remove(a.scene),this.gltf=null)}destructor(){this.removeObjects();super.destructor()}}let S={gen1:{left:{url:z("gen1","left"),transform:(new d.Matrix4).compose(new d.Vector3(0,0,-.1),new d.Quaternion,
new d.Vector3(1,1,1))},right:{url:z("gen1","right"),transform:(new d.Matrix4).compose(new d.Vector3(0,0,-.1),new d.Quaternion,new d.Vector3(1,1,1))}},gen2:{left:{url:z("gen2","left"),transform:(new d.Matrix4).compose(new d.Vector3(.01,-.01,-.05),(new d.Quaternion).setFromEuler(new d.Euler(-.67,0,0)),new d.Vector3(1,1,1))},right:{url:z("gen2","right"),transform:(new d.Matrix4).compose(new d.Vector3(-.01,-.01,-.05),(new d.Quaternion).setFromEuler(new d.Euler(-.67,0,0)),new d.Vector3(1,1,1))}}};class T extends ua{constructor(a){super(a);
this.xrInputSource=null;this.bodyColor=10066329;this.buttonColor=16777215;this.buttonActiveColor=13434828;this.emissiveIntensity=.3}afterUpdate(){let a=this.xrInputSource.handedness;"left"!==a&&"right"!==a&&(a="left");a!==this._hand&&(this._hand=a,this.url=S.gen2[a].url,this.rootTransform=S.gen2[a].transform);this.updateMaterials();super.afterUpdate()}normalize(a){this.meshes=Object.create(null);a.scene.traverse(a=>{a.isMesh&&(a.material=a.material.clone(),this.meshes[a.name]=a)});return a}updateMaterials(){let {meshes:a}=
this;if(a)for(let b in a){let c="body"===b?this.bodyColor:this.buttonColor,e=a[b].material;c!==e._lastColor&&(e.color.set(c),e.emissive.set(c),e._lastColor=c);e.emissiveIntensity=this.emissiveIntensity}}}let D=[{match:a=>/Oculus/.test(navigator.userAgent)||a.profiles&&a.profiles.some(a=>/oculus-touch/.test(a)),facade:T},{match:a=>!0,facade:R,space:"targetRay"}];class U extends h.Group3DFacade{afterUpdate(){var {xrInputSource:a}=this,b=this.modelConfig;if(a&&a!==this._lastSource){this._lastSource=
a;a:{for(b=0;b<D.length;b++)if(D[b].match(a)){b=g.utils.assign({},D[b]);delete b.match;break a}b=void 0}if(b=this.modelConfig=b)b.xrInputSource=a}b&&(a="targetRay"===b.space?this.targetRayPose:this.gripPose,this.visible=!!a,a&&y(a,this),b.rayIntersection=this.rayIntersection);this.children=b||null;super.afterUpdate()}}let V="mousemove mouseover mouseout mousedown mouseup click".split(" "),E=["selectstart","selectend","squeezestart","squeezeend"];var va={value:.3,duration:10},wa={value:1,duration:20};
let xa={facade:L},ya={facade:O},za={facade:U};class W extends h.Group3DFacade{constructor(a){super(a);this.isXRInputSource=!0;this.rayIntersection=this.gripPose=this.targetRayPose=this.xrReferenceSpace=this.xrSession=this.xrInputSource=null;this.cursor=g.utils.assign(xa);this.targetRay=g.utils.assign(ya);this.grip=g.utils.assign(za);this.isPointing=!0;this.clickOnPoke=!1;this.children=[null,null,null];this._ray=new d.Ray;this._onSessionEvent=this._onSessionEvent.bind(this);this._onSceneRayEvent=this._onSceneRayEvent.bind(this);
this.addEventListener("xrframe",this._onXrFrame.bind(this));w(this.getSceneFacade(),!0,V,this._onSceneRayEvent)}afterUpdate(){let {xrSession:a,_lastXrSession:b,xrInputSource:c,rayIntersection:e,children:d,isPointing:l,cursor:q,targetRay:f,grip:h,targetRayPose:p,gripPose:m}=this;a!==b&&(this._lastXrSession=a,w(b,!1,E,this._onSessionEvent),this._isXrStandardGamepad()||w(a,!0,E,this._onSessionEvent));let g=null,k=null,r=null;"screen"!==c.targetRayMode&&(g=l&&q)&&(g.key="cursor",g.targetRayPose=p,g.gripPose=
m,g.rayIntersection=e,g.xrInputSource=c);if("tracked-pointer"===c.targetRayMode){if(k=l&&f)k.key="targetRay",k.targetRayPose=p,k.gripPose=m,k.rayIntersection=e,k.xrInputSource=c;if(r=m?h:null)r.key="grip",r.targetRayPose=p,r.gripPose=m,r.rayIntersection=e,r.xrInputSource=c}d[0]=g;d[1]=k;d[2]=r;super.afterUpdate()}_onXrFrame(a,b){let {xrInputSource:c,isPointing:e,_ray:d}=this;if(a=this.getCameraFacade().offsetReferenceSpace){let {targetRaySpace:l,gripSpace:J}=c,f=b.getPose(l,a);f&&e&&(d.origin.copy(f.transform.position),
d.direction.set(0,0,-1).applyQuaternion(f.transform.orientation),this.notifyWorld("rayPointerMotion",d));this.targetRayPose=f;this.gripPose=J?b.getPose(J,a):null}this._isXrStandardGamepad()&&this._trackGamepadState(c.gamepad);this.afterUpdate()}_isXrStandardGamepad(){let {gamepad:a}=this.xrInputSource;return a&&"xr-standard"===a.mapping}_trackGamepadState(a){var b=a.buttons,c=this._buttonPresses||(this._buttonPresses=[]),e=Date.now();let d=this._ray;for(let a=0;a<b.length;a++)b[a].pressed!==!!c[a]&&
(this.isPointing&&(this.notifyWorld("rayPointerAction",{ray:d,type:b[a].pressed?"mousedown":"mouseup",button:a}),c[a]&&!b[a].pressed&&300>=e-c[a]&&this.notifyWorld("rayPointerAction",{ray:d,type:"click",button:a})),c[a]=b[a].pressed?e:null),c.length=b.length;a=a.axes;for(b=0;b<a.length;b+=2)c=10*(a[b]||0),e=10*(a[b+1]||0),.1<Math.hypot(c,e)&&this.isPointing&&this.notifyWorld("rayPointerAction",{ray:d,type:"wheel",deltaX:c,deltaY:e,deltaMode:0})}_onSessionEvent(a){if(a.inputSource===this.xrInputSource){let b=
/^squeeze/.test(a.type)?1:0;this.notifyWorld("rayPointerAction",{ray:this._ray,type:/start$/.test(a.type)?"mousedown":"mouseup",button:b});/end$/.test(a.type)&&this.notifyWorld("rayPointerAction",{ray:this._ray,type:"click",button:b})}}_onSceneRayEvent(a){if(a.nativeEvent.eventSource===this){let {gamepad:c,targetRayMode:e}=this.xrInputSource;this.rayIntersection=a.intersection;this.afterUpdate();if(c){var b=a.target===a.currentTarget;if(b="click"===a.type?wa:"mouseover"!==a.type||b?null:va){let a=
c.hapticActuators&&c.hapticActuators[0];a&&a.pulse(b.value||1,b.duration||100)}}let d=a.defaultPrevented;(b=>{b&&(b=new Event(b,{bubbles:!0}),b.eventSource=this,a.target.dispatchEvent(b),d=d||b.defaultPrevented)})(X[a.button]&&X[a.button][a.type]);d||"click"!==a.type||5!==a.button||this.notifyWorld("endXRSession");"tracked-pointer"===e&&this.clickOnPoke&&this._checkPokeGesture(a)}}_checkPokeGesture(a){let {intersection:b,target:c}=a,e=this._pokeState||(this._pokeState={target:null,isPoking:!1,time:0}),
d=!!b&&.1>b.distance;d&&(!e.isPoking||c!==e.target)&&500<Date.now()-e.time&&(e.time=Date.now(),this.notifyWorld("rayPointerAction",{ray:a.ray,type:"click",button:0}));e.isPoking=d;e.target=c}destructor(){w(this.xrSession,!1,E,this._onSessionEvent);w(this.getSceneFacade(),!1,V,this._onSceneRayEvent);super.destructor()}}let X={0:{mousedown:"xrselectstart",mouseup:"xrselectend",click:"xrselect"},1:{mousedown:"xrsqueezestart",mouseup:"xrsqueezeend",click:"xrsqueeze"}};g.Facade.defineEventProperty(h.Object3DFacade,
"onXRSelectStart","xrselectstart");g.Facade.defineEventProperty(h.Object3DFacade,"onXRSelect","xrselect");g.Facade.defineEventProperty(h.Object3DFacade,"onXRSelectEnd","xrselectend");g.Facade.defineEventProperty(h.Object3DFacade,"onXRSqueezeStart","xrsqueezestart");g.Facade.defineEventProperty(h.Object3DFacade,"onXRSqueeze","xrsqueeze");g.Facade.defineEventProperty(h.Object3DFacade,"onXRSqueezeEnd","xrsqueezeend");class Aa extends g.ParentFacade{constructor(a){super(a);this._sourcesDirty=!0;this.xrReferenceSpace=
this.xrSession=null;this._xrInputSourceSubtree=new g.ParentFacade(this);this._onInputSourcesChange=a=>{this._sourcesDirty=!0;this.afterUpdate()}}afterUpdate(){let {xrSession:a,_lastXrSession:b}=this;a!==b&&(this._lastXrSession=a,b&&b.removeEventListener("inputsourceschange",this._onInputSourcesChange),a&&a.addEventListener("inputsourceschange",this._onInputSourcesChange));if(this._sourcesDirty){this._sourcesDirty=!1;let b=a&&a.inputSources;this._xrInputSourceSubtree.children=b&&Array.from(b).map(a=>
({facade:W,key:g.utils.getIdForObject(a),xrInputSource:a,xrSession:this.xrSession,xrReferenceSpace:this.xrReferenceSpace}));this._xrInputSourceSubtree.afterUpdate()}super.afterUpdate()}destructor(){this.xrSession&&this.xrSession.removeEventListener("inputsourceschange",this._onInputSourcesChange);super.destructor();this._xrInputSourceSubtree.destructor()}}let A=new d.Vector3,Y=new d.Vector3,Z=new d.Quaternion,Ba={},Ca=new d.Matrix4,la=g.utils.createClassExtender("xrCamera",function(a){return class extends a{constructor(a){super(a);
this.xrReferenceSpace=this.xrSession=null;a=this.threeObject;a.isArrayCamera=!0;a.cameras=[];this.offsetReferenceSpace=null;this.addEventListener("xrframe",this._onXrFrame.bind(this))}afterUpdate(){const {near:a,far:c,xrSession:e}=this,{depthNear:d,depthFar:l}=e.renderState;a===d&&c===l||e.updateRenderState({depthNear:a,depthFar:c});super.afterUpdate()}updateMatrices(){const {xrReferenceSpace:a}=this,c=this._matrixChanged||a!==this._lastRefSpace;super.updateMatrices();c&&(this._lastRefSpace=a,B.invertMatrix4(this.threeObject.matrix,
Ca).decompose(A,Z,Ba),this.offsetReferenceSpace=a?a.getOffsetReferenceSpace(new XRRigidTransform(A,Z)):null)}_onXrFrame(a,c){const {xrSession:b,offsetReferenceSpace:f,threeObject:l}=this;if((a=f&&c.getViewerPose(f))&&b&&b.renderState.baseLayer){c=a.views;for(a=l.cameras;a.length>c.length;)l.layers.disable(a.length--);for(var q=0;q<c.length;q++){var h=c[q],g=a[q];g||(g=a[q]=new d.PerspectiveCamera,g.viewport=new d.Vector4,g.layers.enable(q+1),l.layers.enable(q+1));var p=b.renderState.baseLayer.getViewport(h);
g.viewport.set(p.x,p.y,p.width,p.height);g.matrixWorld.fromArray(h.transform.matrix);g.matrixWorldInverse.fromArray(h.transform.inverse.matrix);g.projectionMatrix.fromArray(h.projectionMatrix)}if(2===c.length){c=a[0];q=a[1];A.setFromMatrixPosition(c.matrixWorld);Y.setFromMatrixPosition(q.matrixWorld);a=A.distanceTo(Y);var m=c.projectionMatrix.elements,k=q.projectionMatrix.elements;p=m[14]/(m[10]-1);q=m[14]/(m[10]+1);h=(m[9]+1)/m[5];g=(m[9]-1)/m[5];var n=(m[8]-1)/m[0],r=(k[8]+1)/k[0];m=p*n;k=p*r;r=
a/(-n+r);n=r*-n;c.matrixWorld.decompose(l.position,l.quaternion,l.scale);l.translateX(n);l.translateZ(r);l.matrixWorld.compose(l.position,l.quaternion,l.scale);B.invertMatrix4(l.matrixWorld,l.matrixWorldInverse);c=p+r;p=q+r;l.projectionMatrix.makePerspective(m-n,k+(a-n),h*q/p*c,g*q/p*c,c,p)}}}}}),aa=[],F=new d.Vector2,ba=new WeakMap;class G extends h.World3DFacade{afterUpdate(){this._togglePointerListeners(!this._isImmersive());super.afterUpdate();let {xrSession:a,_threeRenderer:b}=this,c=ba.get(this);
if(a!==c)if(ba.set(this,a),this.renderingScheduler=a||window,ja.setAnimationScheduler(a||window),a){let e=a.renderState.baseLayer,c=b.getContext();e&&e._glContext===c?C(b,e.framebuffer):(c.makeXRCompatible?c.makeXRCompatible():Promise.resolve()).then(()=>{if(this.xrSession===a){var d=XRWebGLLayer,f=!!b.getContextAttributes().antialias;{var g=this.xrFramebufferScaleFactor;let b=1;null!=g&&("string"===typeof g?/native/.test(g)&&(g=+g.replace(/\s*native\s*/,"")||1,b=XRWebGLLayer.getNativeFramebufferScaleFactor(a)*
g):b=+g,isNaN(b)&&(b=1));g=b}e=new d(a,c,{antialias:f,framebufferScaleFactor:g});e._glContext=c;a.updateRenderState({baseLayer:e});C(b,e.framebuffer);this._queueRender()}})}else C(b,null),b.setRenderTarget(b.getRenderTarget()),b.getSize(F),b.setDrawingBufferSize(F.x,F.y,b.getPixelRatio()),this._queueRender()}doRender(a,b){b&&b.session&&this.eventRegistry.forEachListenerOfType("xrframe",c=>c(a,b),this);super.doRender()}_isOpaque(){return this.xrSession&&"opaque"===this.xrSession.environmentBlendMode}_isImmersive(){return this.xrSession&&
"inline"!==this.xrSessionMode}_getCameraDef(){let a=super._getCameraDef();this._isImmersive()&&(a.facade=K(a.facade),a.xrSession=this.xrSession,a.xrReferenceSpace=this.xrReferenceSpace);return a}_getSceneDef(){let a=super._getSceneDef(),{xrSession:b,xrReferenceSpace:c}=this;b&&c&&(a.objects=aa.concat(a.objects,{key:"xrInputMgr",facade:Aa,xrSession:b,xrReferenceSpace:c}));return a}_isContinuousRender(){return this.xrSession||this.continuousRender}_doRenderHtmlItems(){this._isImmersive()?this.renderHtmlItems&&
this.renderHtmlItems(aa):super._doRenderHtmlItems()}}G.prototype._notifyWorldHandlers=Object.create(h.World3DFacade.prototype._notifyWorldHandlers,{endXRSession:{value:function(a,b){this.xrSession&&this.xrSession.end()}}});x=["inline","immersive-vr"];k={xrSupported:k["default"].bool,xrSupportedSessionModes:k["default"].arrayOf(k["default"].oneOf(x)),xrSession:k["default"].object,xrSessionMode:k["default"].oneOf(x),xrReferenceSpace:k["default"].object,xrReferenceSpaceType:k["default"].oneOf(["viewer",
"local","local-floor","bounded-floor","unbounded"]),xrLauncher:k["default"].element};let Da=g.utils.memoize(()=>(new d.CylinderGeometry(1,1,1,64,1,!0)).rotateX(Math.PI/2)),Ea=g.utils.memoize(()=>new d.MeshStandardMaterial({color:3355443,side:d.DoubleSide}));class Fa extends h.Object3DFacade{constructor(a){super(a,new d.Mesh(Da(),Ea()))}set smallRadius(a){this.scaleX=a}set largeRadius(a){this.scaleY=a}set width(a){this.scaleZ=a}}let Ga=g.utils.memoize(()=>{let a=2*Math.PI,b=(new d.Shape).moveTo(.012,
0);for(let c=0;8>c;c++){let e=c/8*a;b.lineTo(.01*Math.cos(e),.01*Math.sin(e));e=(c+.5)/8*a;b.lineTo(.01*Math.cos(e),.01*Math.sin(e));b.lineTo(.012*Math.cos(e),.012*Math.sin(e));7===c?b.lineTo(.012,0):(e=(c+1)/8*a,b.lineTo(.012*Math.cos(e),.012*Math.sin(e)))}b.holes.push((new d.Path).absellipse(0,0,.006,.006,0,a,!1));return new d.ExtrudeGeometry(b,{curveSegments:16,depth:.005,bevelEnabled:!1})});class Ha extends h.MeshFacade{get geometry(){return Ga()}}let Ia=new d.Vector3,Ja={from:{rotateX:0},to:{rotateX:2*
Math.PI},duration:5E3,iterations:Infinity},H=Math.PI/4,ca=.035*.75;class Ka extends h.Group3DFacade{syncPose(a){if(a){if(this.visible=!0,y(a,this),this.traverse(ma),this.onCogMove&&this._cogFacade)this.onCogMove(this._cogFacade.getWorldPosition(Ia))}else this.visible=!1}describeChildren(){let {active:a}=this,b=this._childTpl||(this._childTpl={key:"g",facade:h.Group3DFacade,rotateX:-H,y:.08*Math.cos(H),z:.08*Math.sin(H),children:[{key:"strap",facade:Fa,smallRadius:ca,largeRadius:.035,width:.025},{key:"cog",
facade:Ha,ref:a=>{this._cogFacade=a},rotateY:Math.PI/2,x:ca,animation:null,transition:{scale:{duration:500,easing:"easeOutBack"},"material.color":{interpolate:"color"}}}]}),[,c]=b.children;c.scale=a?1.75:1;c["material.color"]=a?3381759:10066329;c.animation=a?Ja:null;return b}}let La=`
uniform float time;
uniform vec4 fade;
uniform vec3 color;
varying vec2 vUV;

float distToScanline(float x, float separation, float velocity) {
  x += time / 1000.0 * velocity;
  float dist = abs(x - round(x / separation) * separation);
  return dist;
}

void main() {
  float alpha = ${.2};
  ${[{sep:.4,vel:.15,size:.1,alpha:.1},{sep:.7,vel:.2,size:.15,alpha:.1},{sep:.3,vel:.3,size:.1,alpha:.1},{sep:.2,vel:.6,size:.1,alpha:.04},{sep:.1,vel:.4,size:.02,alpha:.04}].map(({sep:a,vel:b,size:c,alpha:e})=>`alpha += ${e} * smoothstep(${c/2}, 0.0, distToScanline(vUV.y, ${a}, ${b}));`).join("\n")}
  alpha *= min(smoothstep(fade.x, fade.y, vUV.y), smoothstep(fade.w, fade.z, vUV.y));
  gl_FragColor = vec4(color, alpha);
}
`,Ma=Date.now(),Na=function(){return new d.ShaderMaterial({uniforms:{time:{get value(){return Ma-Date.now()}},color:{value:new d.Color},fade:{value:new d.Vector4(0,.4,.7,1)}},vertexShader:"\nvarying vec2 vUV;\nvoid main() {\n  vUV = uv;\n  if (uv.y == 0.0) { //src pos is worldspace\n    gl_Position = projectionMatrix * viewMatrix * vec4(position, 1.0);\n  } else {\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  }\n}\n",fragmentShader:La,transparent:!0})};class Oa extends h.MeshFacade{constructor(a){super(a);
this.threeObject.frustumCulled=!1;this.renderOrder=99999;this.geometry=new d.BufferGeometry;this.autoDisposeGeometry=!0;this.color=3381759;this.material=Na()}syncSourcePosition(){let {sourceWorldPosition:a}=this,b=this.threeObject.geometry.getAttribute("position");a&&b&&(a.x!==b.getX(0)||a.y!==b.getY(0)||a.z!==b.getZ(0))&&(b.setXYZ(0,a.x,a.y,a.z),b.needsUpdate=!0)}afterUpdate(){let {targetVertices:a,geometry:b,color:c}=this;var e=this.geometry.getAttribute("position");if(!e||e._data!==a){e=new Float32Array(a.length+
3);e.set(a,3);e=new d.BufferAttribute(e,3);e.usage=d.DynamicDrawUsage;b.setAttribute("position",e);e=new d.BufferAttribute(new Float32Array(2*e.count),2);for(let a=1;a<e.count;a++)e.setY(a,1);b.setAttribute("uv",e);e=[];for(let b=1,c=a.length/3;b<=c;b++)e.push(0,1===b?c:b-1,b);b.setIndex(e)}this.syncSourcePosition();null==c&&(c=3381759);c!==this._color&&this.material.uniforms.color.value.set(this._color=c);super.afterUpdate()}}let Pa=new d.Matrix4,n=new d.Vector3,u=new d.Vector3;class Qa extends h.Object3DFacade{constructor(a){super(a,
new d.Group);this.distancePastGrip=.25;this.minDistanceFromCamera=.5;this.heightAboveGrip=.15;this.platformRadius=.25;this.gripPose=this.projectionSourcePosition=this.projectionColor=null;this.keepContentAlive=this.active=!1}syncPose(a){var b=!1;a&&(b=this.getCameraFacade().threeObject,u.setFromMatrixPosition(b.matrixWorld).applyMatrix4(B.invertMatrix4(this.threeObject.parent.matrixWorld,Pa)),this.active?(n.copy(a.transform.position),n.y=u.y,n.sub(u),n.setLength(Math.max(this.minDistanceFromCamera,
n.length()+this.distancePastGrip)),n.add(u),n.y=a.transform.position.y+this.heightAboveGrip,b=1):(n.copy(a.transform.position),b=.001),a=this.threeObject.position,a.lerp(n,.05),this.scale+=.3*(b-this.scale),b=.01<this.scale)&&(this.rotateY=Math.atan2(u.x-a.x,u.z-a.z),(a=this.getChildByKey("$projection"))&&a.syncSourcePosition(),this.traverse(na));b!==this.visible&&this.update({visible:b})}describeChildren(){if(!this.visible&&!this.keepContentAlive)return null;let a=this._kidsTpl||(this._kidsTpl=[{key:"$platform",
facade:h.CircleFacade,radius:1,material:"lambert",castShadow:!0,receiveShadow:!0,"material.color":3355443},{key:"$projection",facade:Oa,sourceWorldPosition:new d.Vector3,targetVertices:Object.freeze(function(){let a=[];for(let b=0;32>b;b++){let c=b/32*Math.PI*2;a.push(Math.cos(c),0,Math.sin(c))}return a}())}]);a[0].scale=a[1].scale=this.platformRadius;a[1].sourceWorldPosition=this.projectionSourcePosition;a[0]["material.color"]=this.platformColor;a[1].color=this.projectionColor;return a.concat(this.children)}}
let Ra=new d.Matrix4,Sa=new d.Quaternion,da=new d.Vector3,Ta=new d.Vector3(0,1,0);class Ua extends h.Group3DFacade{constructor(a){super(a);this.activeUpAngle=Math.PI/7;this.preferredHand="left";this.platformRadius=.25;this.platformColor=3355443;this.projectionColor=3381759;this.keepContentAlive=!1;this.gripPose=this.onActiveChange=null;this.active=!1;this._cogPos=new d.Vector3;this.addEventListener("xrframe",this.onXRFrame.bind(this))}describeChildren(){if(!this.gripPose)return null;let a=this._childTpl||
(this._childTpl=[{key:"wristband",facade:Ka,active:!1,gripPose:null,onCogMove:a=>{this._cogPos.copy(a)}},{key:"content",facade:Qa,active:!1,gripPose:null,children:null}]),[b,c]=a;b.active=c.active=this.active;c.platformRadius=this.platformRadius;c.platformColor=this.platformColor;c.projectionColor=this.projectionColor;c.projectionSourcePosition=this._cogPos;c.keepContentAlive=this.keepContentAlive;c.children=this.children;return a}updateMatrices(){this.threeObject.matrixWorld.copy(this.getCameraFacade().threeObject.matrix);
this.markWorldMatrixDirty()}onXRFrame(a,b){let c=null;a=!1;var e=b.session.inputSources;if(e){let d=null;for(let a=0,b=e.length;a<b;a++)if(e[a].handedness===this.preferredHand){d=e[a].gripSpace;break}d&&(e=this.getCameraFacade(),c=b.getPose(d,e.xrReferenceSpace))&&(da.set(1,0,0).applyQuaternion(Sa.setFromRotationMatrix(Ra.fromArray(c.transform.matrix))),a=da.angleTo(Ta)<this.activeUpAngle)}if(a!==this.active){if(this.onActiveChange)this.onActiveChange(a);this.update({active:a})}!!c!==!!this.gripPose?
this.update({gripPose:c}):c&&this.forEachChild(a=>a.syncPose(c))}}let ea=Math.PI/180,fa=function(){let a=new d.Shape;a.moveTo(.15,-.15).lineTo(.15,0).absellipse(0,0,.15,.15,0,270*ea,!1,0).lineTo(.15,-.15);a.holes=[(new d.Path).moveTo(.1,-.1).lineTo(0,-.1).absellipse(0,0,.1,.1,270*ea,0,!0,0).lineTo(.1,-.1)];let b=(new d.ExtrudeGeometry(a,{curveSegments:64,depth:.05,bevelEnabled:!1})).rotateX(Math.PI/2).rotateY(Math.PI/4).translate(0,.05,0);fa=()=>b;return b};class Va extends h.MeshFacade{constructor(a){super(a);
this.geometry=fa();this.material=new d.MeshLambertMaterial({transparent:!0,opacity:.8});this.autoDisposeGeometry=!0}}let ha=(new d.Plane).setComponents(0,1,0,0),t=new d.Vector3,ia=new d.Quaternion,Wa=new d.Sphere(void 0,Infinity);class Xa extends h.Object3DFacade{constructor(a){super(a,new d.Group);this.maxDistance=10;this.targeting=!1;this.onTeleport=null;let b=this.markerConfig={key:"marker",facade:Va,"material.color":13209,visible:!1};this.children=[b];let c=0;this.addEventListener("dragstart",
a=>{c=0;this.targeting=!0;this.afterUpdate()});this.addEventListener("drag",a=>{this.targeting&&((a=a.ray.intersectPlane(ha,t))&&a.distanceTo(this.getCameraPosition())<this.maxDistance?(this.targeting=!0,b.x=t.x,b.z=t.z,this.requestRender(),ia.setFromRotationMatrix(this.getCameraFacade().threeObject.matrixWorld),t.set(0,0,-1).applyQuaternion(ia),b.rotateY=Math.atan2(-t.x,-t.z)+c):this.targeting=!1,this.afterUpdate())});this.addEventListener("dragend",a=>{this.targeting&&(this.targeting=!1,this.afterUpdate(),
this.onTeleport({position:{x:b.x,z:b.z},rotation:b.rotateY}))});let e=Math.PI/-4,f=0;this.addEventListener("wheel",a=>{if(this.targeting)c=Math.atan2(-a.deltaX,-a.deltaY);else{let b=Date.now();500<b-f&&Math.abs(a.deltaX)>Math.abs(a.deltaY)&&(f=b,this.onTeleport({rotation:Math.sign(a.deltaX)*e+this.getCameraFacade().rotateY}))}})}afterUpdate(){this.markerConfig.visible=this.targeting;super.afterUpdate()}getBoundingSphere(){return Wa}raycast(a){let b=a.ray.intersectPlane(ha,t);return b?[{distance:a.ray.origin.distanceTo(b),
point:b.clone()}]:null}}f.AXIS_THUMBSTICK_X=2;f.AXIS_THUMBSTICK_Y=3;f.AXIS_TOUCHPAD_X=0;f.AXIS_TOUCHPAD_Y=1;f.BUTTON_DEFAULT_BACK=5;f.BUTTON_SQUEEZE=1;f.BUTTON_THUMBSTICK=3;f.BUTTON_TOUCHPAD=2;f.BUTTON_TRIGGER=0;f.BasicGrip=R;f.CursorFacade=L;f.GripFacade=U;f.OculusTouchGrip=T;f.ReactXRAware=function(a,b){b=g.utils.assign({xrLauncherRenderer:oa,sessionModes:["immersive-vr"],referenceSpaces:["bounded-floor","local-floor"],framebufferScaleFactor:1},b);class c extends v["default"].Component{constructor(a){super(a);
this.state={xrSupportedSessionModes:[],xrSession:null,xrSessionMode:null,xrReferenceSpace:null,xrReferenceSpaceType:null};["_checkXrSupport","_onSessionEnded","_onLauncherSelect"].forEach(a=>{this[a]=this[a].bind(this)});(a=navigator.xr)&&a.addEventListener("devicechange",this._checkXrSupport);this._checkXrSupport()}componentWillUnmount(){let a=navigator.xr;a&&a.removeEventListener("devicechange",this._checkXrSupport)}_checkXrSupport(){let a=navigator.xr;if(a){let c=[];Promise.all(b.sessionModes.map(b=>
"function"===typeof a.isSessionSupported?a.isSessionSupported(b).then(a=>{a?c.push(b):console.info(`XR session type '${b}' not supported`)}):a.supportsSession(b).then(()=>{c.push(b)},a=>{console.info(`XR session type '${b}' not supported`,a)}))).then(()=>{this.setState({xrSupportedSessionModes:c})})}else this.setState({xrSupportedSessionModes:[]})}_startSession(a){let {xrSupportedSessionModes:c,xrSession:d}=this.state;d&&d.end();if(c.includes(a)){let c=b.referenceSpaces;c&&c.length?navigator.xr.requestSession(a,
{optionalFeatures:c.slice(0,-1),requiredFeatures:c.slice(-1)}).then(b=>{b.addEventListener("end",this._onSessionEnded,!1);let d=(a=0)=>{const e=c[a];return b.requestReferenceSpace(e).then(a=>[a,e]).catch(b=>{console.debug(`Reference space ${e} not supported or denied by user.`,b);if(a+1===c.length)throw Error(`All requested referenceSpaces (${c.join(", ")}) are either unsupported or were denied by the user.`);return d(a+1)})};return d().then(([c,d])=>{this.setState({xrSession:b,xrSessionMode:a,xrReferenceSpace:c,
xrReferenceSpaceType:d})})}).catch(a=>{console.error(a)}):console.error("XRAware `referencesSpaces` cannot be empty")}}_onSessionEnded(a){a.session.removeEventListener("end",this._onSessionEnded,!1);this.setState({xrSession:null,xrSessionMode:null,xrReferenceSpace:null,xrReferenceSpaceType:null})}_onLauncherSelect(a){this._startSession(a)}render(){let {props:c,state:d}=this,{xrSupportedSessionModes:f,xrSession:k,xrSessionMode:n,xrReferenceSpace:t,xrReferenceSpaceType:p}=d,m=0<f.length,u=v["default"].createElement(b.xrLauncherRenderer,
{xrSupportedSessionModes:f,xrSupported:m,xrSession:k,onSelectSession:this._onLauncherSelect});return v["default"].createElement(h.Canvas3D.contextType.Provider,{value:{worldFacade:G,worldProps:{xrSession:k,xrSessionMode:n,xrReferenceSpace:t,xrReferenceSpaceType:p,xrFramebufferScaleFactor:b.framebufferScaleFactor}}},v["default"].createElement(a,g.utils.assign({},c,{xrSupported:m,xrSupportedSessionModes:f,xrSession:k,xrSessionMode:n,xrReferenceSpace:t,xrReferenceSpaceType:p,xrLauncher:u}),c.children))}}
c.displayName=`XRAware(${a.displayName||a.name||"?"})`;return c};f.TARGET_RAY_RENDERORDER=1E8;f.TargetRayFacade=O;f.TeleportControls=Xa;f.WorldXRFacade=G;f.WristMountedUI=Ua;f.XRAwarePropTypes=k;f.XRInputSourceFacade=W;f.copyXRPoseToFacadeProps=y;f.extendAsXRCamera=K;Object.defineProperty(f,"__esModule",{value:!0})})
